---
title: "q5"
output: html_document
---

```{r setup, include=FALSE}
library(readr)
library(forecast)
library(xts)
getwd()
library(dplyr)
library(fpp)
library(fpp3)
library(gridExtra)
library(ggplot2)
library(ranger)
library(ftsa)
library(Metrics)
library(smooth)
library(Mcomp)
library(rmarkdown)
library(fable)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:
#Step 1 read the csv datasets files
```{r}
data = read.csv("/Users/Bryan/Google Drive/Cours/DSBA/T1/1. Forecasting & Predictive Analysis/6. Project/Projectdata.csv")

tsdata <- xts(data[,2:19], as.Date(data$date))
```

#Step 2 Aggregate the data by week
```{r}
weekly = apply.weekly(tsdata[,1:18], sum)

weekly = apply.weekly(tsdata, function(d){
  c(Hobbies_CA_1 = sum(d$Hobbies_CA_1),
    Hobbies_CA_2 = sum(d$Hobbies_CA_2),
    Hobbies_CA_3 = sum(d$Hobbies_CA_3),
    Household_1_CA_1 = sum(d$Household_1_CA_1),
    Household_1_CA_2 = sum(d$Household_1_CA_2),
    Household_1_CA_3 = sum(d$Household_1_CA_3),
    Household_2_CA_1 = sum(d$Household_2_CA_1),
    Household_2_CA_2 = sum(d$Household_2_CA_2),
    Household_2_CA_3 = sum(d$Household_2_CA_3),
    Foods_1_CA_1 = sum(d$Foods_1_CA_1),
    Foods_1_CA_2 = sum(d$Foods_1_CA_2),
    Foods_1_CA_3 = sum(d$Foods_1_CA_3),
    Foods_2_CA_1 = sum(d$Foods_2_CA_1),
    Foods_2_CA_2 = sum(d$Foods_2_CA_2),
    Foods_2_CA_3 = sum(d$Foods_2_CA_3),
    Foods_3_CA_1 = sum(d$Foods_3_CA_1),
    Foods_3_CA_2 = sum(d$Foods_3_CA_2),
    Foods_3_CA_3 = sum(d$Foods_3_CA_3)
    )
})

```
#Step 3 perform training and testing data split
split: 70-30
```{r 70-30}
train1 <- head(weekly, 198)
test1 <- tail(weekly, 84)
```

split: 80-20
```{r 80-20}
train2 <- head(weekly, 226)
test2 <- tail(weekly, 56)
```

split: 90-10
```{r}
train3 <- head(weekly, 254)
test3 <- tail(weekly, 28)
```

# Step 3 perform forecasts using different methods
```{r}
train_names <- c('train1', 'train2', 'train3')
test_names <- c('test1', 'test2', 'test3')

variables <- colnames(train1)

h = seq(1:28)  # the horizons
```


```{r}
# Naive
# Predict the next 28 values
df_naive =data.frame(mat)
c = 1
for (i in 1:length(train_names)){
  for (n in 1:length(variables)){
    df_naive[1,c] = train_names[i]
    df_naive[2,c] = variables[n]
    naivef <- naive(get(paste0("train",i))[,n],h=28)
    rmsse <- sqrt(sum(as.numeric(head(get(paste0("test",2))[,1], 28)) - naivef$mean)**2 / 28)
    df_naive[3,c] = rmsse
    df_naive[4,c] = 28
    c = c+1
  }
}

rownames(df_naive) <- c("Set","Variable","RMSSE", "horizon")
print(df_naive)

```

```{r}
# sNaive
# 1-step ahead forecast
mat = matrix(ncol = 18, nrow = 4)
df_snaive = data.frame(mat)

c = 1
for (i in 1:length(train_names)){
  for (n in 1:length(variables)){
    df_snaive[1,c] = train_names[i]
    df_snaive[2,c] = variables[n]
    snaivef <- snaive(get(paste0("train",i))[,n],h=28)
    rmsse <- sqrt(sum(snaivef$residuals, na.rm = TRUE) / length(df_snaive$residuals))
    df_snaive[3,c] = a = sqrt(sum(as.numeric(head(get(paste0("test",2))[,1], 28)) - snaivef$mean)**2 / 28)
    df_snaive[4,c] = 28
    c = c+1
  }
}

a = snaive(get(paste0("train",1))[,1],h=28)


df_sn = as.data.frame(a)


rownames(df_snaive) <- c("Set","Variable","RMSSE", "horizon")
print(df_snaive)
```

```{r}
# ES
# Predict the next 28 values
mat = matrix(ncol = 18, nrow = 4)
df_es = data.frame(mat)

c = 1
for (i in 1:length(train_names)){
  for (n in 1:length(variables)){
    df_es[1,c] = train_names[i]
    df_es[2,c] = variables[n]
    esf <- ses(get(paste0("train",i))[,n],h=28)
    actual = as.numeric(head(get(paste0("train",i))[,n], 28))
    df_esf = as.data.frame(esf)
    predictions = df_esf$`Point Forecast`
    df_es[3,c] = rmse(actual, predictions)
    df_es[4,c] = 28
    c = c+1
  }
}

rownames(df_es) <- c("Set","Variable","RMSSE", "horizon")
print(df_es)
```


```{r}
# MA
# Predict the next 28 values
mat = matrix(ncol = 18, nrow = 4)
df_ma = data.frame(mat)

c = 1
for (i in 1:length(train_names)){
  for (n in 1:length(variables)){
    df_ma[1,c] = train_names[i]
    df_ma[2,c] = variables[n]
    maf <- forecast(ma(get(paste0("train",i))[,n], order = 15, centre = FALSE),h=28)
    actual = as.numeric(head(get(paste0("train",i))[,n], 28))
    df_maf = as.data.frame(maf)
    predictions = df_maf$`Point Forecast`
    df_ma[3,c] = rmse(actual, predictions)
    df_ma[4,c] = 28
    c = c+1
  }
}

rownames(df_ma) <- c("Set","Variable","RMSSE", "horizon")
print(df_ma)
```
```{r}
# SARIMA
# Predict the next 28 values
mat = matrix(ncol = 18, nrow = 4)
df_sma = data.frame(mat)

c = 1
for (i in 1:length(train_names)){
  for (n in 1:length(variables)){
    df_sma[1,c] = train_names[i]
    df_sma[2,c] = variables[n]
    smaf <- forecast::forecast(auto.arima(get(paste0("train",i))[,n],D=1,seasonal=TRUE), h=28)
    actual = as.numeric(head(get(paste0("train",i))[,n], 28))
    df_smaf = as.data.frame(smaf)
    predictions = df_maf$`Point Forecast`
    df_sma[3,c] = rmse(actual, predictions)
    df_sma[4,c] = 28
    c = c+1
  }
}

rownames(df_sma) <- c("Set","Variable","RMSSE", "horizon")
print(df_sma)
```
```{r}
# SARIMAX

```

```{r}
# Holt-Winters
mat = matrix(ncol = 18, nrow = 4)
df_hw = data.frame(mat)

c = 1
for (i in 1:length(train_names)){
  for (n in 1:length(variables)){
    df_hw[1,c] = train_names[i]
    df_hw[2,c] = variables[n]
    hwf <- forecast::forecast(HoltWinters(get(paste0("train",i))[,n], gamma = FALSE), h=28)
    actual = as.numeric(head(get(paste0("train",i))[,n], 28))
    df_hwf = as.data.frame(hwf)
    predictions = df_hwf$`Point Forecast`
    df_hw[3,c] = rmse(actual, predictions)
    df_hw[4,c] = 28
    c = c+1
  }
}

rownames(df_hw) <- c("Set","Variable","RMSSE", "horizon")
print(df_hw)

```
```{r}
# SARIMAX

```
